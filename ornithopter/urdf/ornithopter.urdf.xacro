<?xml version="1.0"?>
<robot name="ornithopter" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- ==================== Base Structure ==================== -->
  <link name="platform">
    <inertial>
      <origin xyz="0 0.03 0" rpy="0 0 0"/>
      <mass value="0.2"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
    <visual>
      <origin xyz="0 0.03 0.0" rpy="0 0 0"/>
      <geometry>
        <box size="0.09 0.09 0.04"/> 
      </geometry>
      <material name="Gazebo/Red"/>
    </visual>
    <collision>
      <origin xyz="0 0.03 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.09 0.09 0.04"/>
      </geometry>
    </collision>
  </link>

  <joint name="platform_fixed" type="fixed">
    <parent link="platform"/>
    <child link="base_link"/>
    <origin xyz="0 0 0.025" rpy="0 0 0"/>
  </joint>

  <!-- ==================== Main Body ==================== -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <mass value="0.9"/>
      <inertia ixx="0.05" ixy="0.0" ixz="0.0" iyy="0.08" iyz="0.0" izz="0.08"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_0.STL" scale="1 1 1"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_0.STL" scale="1 1 1"/>
      </geometry>
    </collision>
  </link>

  <!-- ==================== Wings ==================== -->
  <link name="link_4">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.4"/>
      <inertia ixx="0.005" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_4.STL" scale="1 1 1"/>
      </geometry>
    </visual>
    <!-- <collision>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_4.STL" scale="1 1 1"/>
      </geometry>
    </collision> -->
  </link>

  <joint name="joint_4" type="revolute">
    <origin xyz="0 0.03 0.0375" rpy="1.5708 0 0"/>
    <parent link="base_link"/>
    <child link="link_4"/>
    <axis xyz="1 0 0"/>
    <limit lower="-1.05" upper="1.05" effort="500" velocity="5000"/>
    <dynamics damping="0.05" friction="0.0"/>
  </joint>
  <!--test cp-->
  <!-- <link name= "cpl">
    <visual>
      <geometry>
        <box size= "0.1 0.1 0.1"/>
      </geometry> 
    </visual>
  </link>
  <joint name="cplj" type="fixed">
    <parent link="link_4"/>
    <child link="cpl"/>
    <origin xyz="0 0.05 -0.16" rpy="0 0 0"/>
  </joint> -->

  <link name="link_6">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.4"/>
      <inertia ixx="0.005" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_6.STL" scale="1 1 1"/>
      </geometry>
    </visual>
    <!-- <collision>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_6.STL" scale="1 1 1"/>
      </geometry>
    </collision> -->
  </link>

  <joint name="joint_6" type="revolute">
    <origin xyz="0.109 0.0145 0.0375" rpy="1.5708 0 0"/>
    <parent link="base_link"/>
    <child link="link_6"/>
    <axis xyz="1 0 0"/>
    <limit lower="-1.05" upper="1.05" effort="500" velocity="5000"/>
    <dynamics damping="0.05" friction="0.0"/>
  </joint>

  <!--test cp-->
  <!-- <link name= "cpr">
    <visual>
      <geometry>
        <box size= "0.1 0.1 0.1"/>
      </geometry> 
    </visual>
  </link>
  <joint name="cprj" type="fixed">
    <parent link="link_6"/>
    <child link="cpr"/>
    <origin xyz="-0.12 0 0.12" rpy="0 0 0"/>
  </joint> -->

  <!-- ==================== Tail ==================== -->
  <link name="link_8">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.4"/>
      <inertia ixx="0.005" ixy="0.0" ixz="0.0" iyy="0.005" iyz="0.0" izz="0.005"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_8.STL" scale="1 1 1"/>
      </geometry>
    </visual>
    <!-- <collision>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_8.STL" scale="1 1 1"/>
      </geometry>
    </collision> -->
  </link>

  <joint name="joint_8" type="revolute">
    <origin xyz="-0.16 0.023 0.0265" rpy="1.5708 0 0"/>
    <parent link="base_link"/>
    <child link="link_8"/>
    <axis xyz="0 0 1"/>
    <limit lower="-0.52" upper="0.52" effort="10" velocity="100"/>
    <dynamics damping="0.3" friction="0.0"/>
  </joint>

  <link name="link_10">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.4"/>
      <inertia ixx="0.005" ixy="0.0" ixz="0.0" iyy="0.005" iyz="0.0" izz="0.005"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_10.STL" scale="1 1 1"/>
      </geometry>
    </visual>
    <!-- <collision>
      <geometry>
        <mesh filename="file://$(find ornithopter)/meshes/link_10.STL" scale="1 1 1"/>
      </geometry>
    </collision> -->
  </link>

  <joint name="joint_10" type="revolute">
    <origin xyz="-0.16 0.023 0.0265" rpy="1.5708 0 0"/>
    <parent link="base_link"/>
    <child link="link_10"/>
    <axis xyz="0 0 1"/>
    <limit lower="-0.52" upper="0.52" effort="10" velocity="100"/>
    <dynamics damping="0.3" friction="0.0"/>
  </joint>

  <!-- ==================== GPS Sensor ==================== -->
  <link name="gps_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.000001"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.02 0.02 0.02"/>
      </geometry>
      <material>
        <color rgba="1 1 0 1"/>
      </material>
    </visual>
  </link>

  <joint name="gps_joint" type="fixed">
    <origin xyz="0 0 0.1" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="gps_link"/>
  </joint>

  <!-- ==================== Gazebo Plugins ==================== -->
  <gazebo reference="gps_link">
    <sensor name="gps_sensor" type="gps">
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <plugin name="gps_plugin" filename="libgazebo_ros_gps_sensor.so">
        <ros>
          <namespace>/ornithopter</namespace>
          <remapping>~/out:=gps/fix</remapping>
        </ros>
        <frame_name>gps_link</frame_name>
        <topic_name>gps/fix</topic_name>
      </plugin>
    </sensor>
  </gazebo>

 

  <!-- ==================== Visual Materials ==================== -->
  <gazebo reference="base_link"><material>Gazebo/Black</material></gazebo>
  <gazebo reference="link_4"><material>Gazebo/Blue</material></gazebo>
  <gazebo reference="link_6"><material>Gazebo/Green</material></gazebo>
  <gazebo reference="link_8"><material>Gazebo/Orange</material></gazebo>
  <gazebo reference="link_10"><material>Gazebo/Orange</material></gazebo>
  <gazebo reference="gps_link"><material>Gazebo/Yellow</material></gazebo>
  <gazebo reference="platform"><material>Gazebo/Red</material></gazebo>
  <gazebo reference="cpr"><material>Gazebo/White</material></gazebo>
  <gazebo reference="cpl"><material>Gazebo/Grey</material></gazebo>
  

  <!-- ==================== AERODYNAMIC PLUGINS ==================== -->

  <!-- Left Wing Aerodynamics -->
  <gazebo reference="link_4">
    <plugin name="left_wing_aero" filename="libLiftDragPlugin.so">
      <link_name>link_4</link_name>
      <!--direction-->
      <forward>1 0 0</forward>
      <upward>0 1 0</upward>
      <cp>0 0.05 -0.16</cp>
      <!-- geometry -->
      <area>0.000000105</area>
      <fluid_density>1.225</fluid_density>
      <!-- aerodynamic coefficients -->
      <alpha_stall>0.5</alpha_stall>
      <a0>0.0</a0>
      <cla>8.0</cla>
      <cda>0.005</cda>
      <cda_stall>0.1</cda_stall>
    </plugin>
  </gazebo>

  <!-- Right Wing Aerodynamics -->
  <gazebo reference="link_6">
    <plugin name="right_wing_aero" filename="libLiftDragPlugin.so">
      <link_name>link_6</link_name>
      <!--direction-->
      <forward>1 0 0</forward>
      <upward>0 1 0</upward>
      <cp>-0.12 0 0.12</cp>
      <!-- geometry -->
      <area>0.000000105</area>
      <fluid_density>1.225</fluid_density>
      <!-- aerodynamic coefficients -->
      <alpha_stall>0.5</alpha_stall>
      <cda_stall>0.1</cda_stall>
      <a0>0.0</a0>
      <cla>8.0</cla>
      <cda>0.005</cda>
    </plugin>
  </gazebo>




  <ros2_control name="GazeboSystem" type="system">
  <hardware>
    <plugin>gazebo_ros2_control/GazeboSystem</plugin>
  </hardware>

  <joint name="joint_4">
    <command_interface name="position"/>
    <state_interface name="position"/>
    <state_interface name="velocity"/>
    <state_interface name="effort"/>
  </joint>

  <joint name="joint_6">
    <command_interface name="position"/>
    <state_interface name="position"/>
    <state_interface name="velocity"/>
    <state_interface name="effort"/>
  </joint>

  <joint name="joint_8">
    <command_interface name="position"/>
    <state_interface name="position"/>
    <state_interface name="velocity"/>
  </joint>

  <joint name="joint_10">
    <command_interface name="position"/>
    <state_interface name="position"/>
    <state_interface name="velocity"/>
  </joint>
</ros2_control>


  <gazebo>
    <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
      <parameters>$(find ornithopter)/config/ornithopter_controller.yaml</parameters>
    </plugin>
  </gazebo>

</robot>